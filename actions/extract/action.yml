name: "Text Extraction Action"
description: "Extracts text from PDFs and XMLs in processed bill data"

inputs:
  state:
    description: "State to process (2-letter abbreviation)"
    required: true
  github-token:
    description: "GitHub token for authentication"
    required: true
  force-update:
    description: "Force push changes even if there are upstream changes"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install dependencies
      shell: bash
      working-directory: ${{ github.action_path }}/../..
      run: |
        python -m pip install --upgrade pip
        pip install pipenv
        pipenv install --deploy

    - name: Extract Text from PDFs and XMLs
      shell: bash
      working-directory: ${{ github.action_path }}/../..
      run: |
        echo "üìÑ Extracting text from PDFs and XMLs for ${{ inputs.state }}"

        # Check if the data directory exists in the calling repo
        if [ ! -d "${{ github.workspace }}/data_output/data_processed" ]; then
          echo "‚ùå Data directory not found: ${{ github.workspace }}/data_output/data_processed"
          echo "Make sure the data pipeline has been run first"
          exit 1
        fi

        # Configure git for periodic commits
        cd "${{ github.workspace }}"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Create a flag file to control the auto-commit loop
        touch /tmp/text_extraction_running

        # Start background process for periodic commits (every 30 minutes)
        (
          while [ -f /tmp/text_extraction_running ]; do
            sleep 1800  # 30 minutes

            if [ -f /tmp/text_extraction_running ]; then
              cd "${{ github.workspace }}"

              # Check if there are changes
              if ! git diff --quiet data_output/ || ! git diff --staged --quiet data_output/; then
                echo "‚è∞ [$(date)] Auto-committing progress to prevent data loss..."

                git add data_output/

                if ! git diff --staged --quiet; then
                  git commit -m "üîÑ Auto-save text extraction progress for ${{ inputs.state }} - $(date -u +%Y-%m-%dT%H:%M:%SZ)"

                  # Push with retries
                  for i in 1 2 3; do
                    if git push origin main 2>/dev/null; then
                      echo "‚úÖ Progress saved (attempt $i)"
                      break
                    else
                      echo "‚ö†Ô∏è Push failed (attempt $i), retrying..."
                      sleep 5
                    fi
                  done
                fi
              fi
            fi
          done
        ) &

        AUTO_COMMIT_PID=$!
        echo "üîÑ Auto-commit process started (PID: $AUTO_COMMIT_PID)"

        # Change back to action directory to run Python
        cd "${{ github.action_path }}/../.."

        # Run text extraction using the main.py interface with incremental flag
        EXIT_CODE=0
        pipenv run python text_extraction/main.py \
          --state "${{ inputs.state }}" \
          --data-folder "${{ github.workspace }}/data_output/data_processed" \
          --output-folder "${{ github.workspace }}" \
          --incremental || EXIT_CODE=$?

        # Stop the auto-commit background process
        rm -f /tmp/text_extraction_running
        wait $AUTO_COMMIT_PID 2>/dev/null || true

        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Text extraction complete"
        else
          echo "‚ö†Ô∏è Text extraction ended with code $EXIT_CODE (progress has been auto-saved)"
          exit $EXIT_CODE
        fi

    - name: Commit Changes
      shell: bash
      run: |
        echo "üìù Committing extracted text files"

        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Add changes
        git add data_output/

        # Commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Extract text from PDFs/XMLs for ${{ inputs.state }} - $(date)"

          # Push changes
          if [ "${{ inputs.force-update }}" = "true" ]; then
            git push --force-with-lease origin main
          else
            git push origin main
          fi

          echo "‚úÖ Changes committed and pushed"
        fi
